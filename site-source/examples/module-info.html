<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
	<title>Module Info | JavaScript Examples | UIZE JavaScript Framework</title>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
	<meta name="keywords" content="tool"/>
	<meta name="description" content="View detailed info for any module, including a full dependency visualization."/>
	<link rel="alternate" type="application/rss+xml" title="UIZE JavaScript Framework - Latest News" href="http://www.uize.com/latest-news.rss"/>
	<link rel="stylesheet" href="../css/page.css"/>
	<link rel="stylesheet" href="../css/page.example.css"/>
	<style type="text/css">
		.selectorControl {
			width:740px;
			margin:auto;
			padding:10px;
			background:#becacd url(../images/page-contents-bg.gif) repeat-x left top;
			border:1px solid #899;
			border-radius: 3px;
		}

		.moduleInfo {
			margin: 20px auto;
		}

		.moduleInfoItem {
			width: 100%;
			border: 1px solid #ccc;
			text-align: center;
		}
	</style>
</head>

<body>

<script type="text/javascript" src="../js/Uize.js"></script>

<h1 class="document-title">
	<a id="page-homeLink" href="../index.html" title="UIZE JavaScript Framework home"></a>
	<a href="../javascript-examples.html" class="breadcrumb breadcrumbWithArrow">JAVASCRIPT EXAMPLES</a>
	Module Info
	<div id="page-actions" class="pageActions">
		<a href="source-code/module-info.html" class="buttonLink">SOURCE</a>
	</div>
</h1>

<div class="main">
	<!-- explanation copy -->

	<div class="explanation">
		<p>This example lets you view vital statistics for any module, including a breakdown of the module's dependencies and how they contribute to the overal load / weight for the module. Simply select a module from the dropdown menu.</p>
	</div>

	<div class="selectorControl">
		<div style="float:left; line-height:22px; margin-right:5px;">SELECT A MODULE:</div>
		<select id="page-selector" style="float:left; margin-right:15px;"></select>
		<br style="clear:left;"/>
	</div>

	<div style="height:4px;"></div>

	<div id="page-moduleTotalSize"></div>
	<div id="page-moduleInfo" class="moduleInfo"></div>
</div>

<script type="text/javascript">

/*
	- interesting top level summary to show
		- name
		- description
		- type of module
		- meta data (as shown in SOTU table)

		- total dependencies (direct and indirect, excluding module)
		- total number of direct dependencies (excluding module)
		- total number of indirect dependencies (excluding module)
		- sizes
			- total compressed size of module and all dependencies
			- compressed size of module alone (and percentage of total)
			- total compressed size of all dependencies (and percentage of total)
		- how many modules throughout the codebase rely on this module (requires scanning entire codebase)
		- link to documentation
	- for any module in the dependency list
		- same information as shown in top level summary for module, but in a tooltip
		- linkable to switch the currently selected module
	- questions to answer
		- if I add or remove direct dependencies to a module...
			- how is the overal module dependency list and size affected
			- how is the size of other dependent modules affected (as a percentage change on their current total size)
		- if I change the size of a module...
			- how is the size of other dependent modules affected (as a percentage change on their current total size)
		- basically, provide information on consquences on the codebase to making typical kinds of changes
			- like optimizing code of a module
			- like adding or removing dependencies
		- what's the impact of making a change?
			- taking into account the modules that are affected and how important they are / how in use they are by other modules
		- for any module in the dependency list, which modules are using it directly
	- list of all dependencies, including self
		- showing the following fields (sortable on any of them)
			- module name
			- dependency index
			- dependency level
			- direct dependencies
			- size (compressed)
			- size (compressed), as a percent of total
			- total size contribution (size of self plus all non-shared dependencies)
			- used by how many other modules in this dependency graph
			- size of non-shared dependencies in this dependency graph
	- create files builder module for the build process to build all the module info modules
*/

Uize.module ({
	required:[
		'UizeSite.Page.Example',
		'UizeSite.ModulesTree',
		'Uize.Url',
		'Uize.Data.PathsTree',
		'Uize.Util.Dependencies.Async'
	],
	builder:function () {
		'use strict';

		var _selectorPlaceholderText = '-- NO MODULE SELECTED --';

		/*** prepare list of all modules ***/
			var _modulesList = Uize.Data.PathsTree.toList (UizeSite.ModulesTree ());

		/*** create the example page widget ***/
			var _page = window.page = UizeSite.Page.Example ();

		/*** wire up the page widget ***/
			_page.wireUi ();

		/*** dependency tracing logic (asynchronous) ***/
			var
				_moduleInfoLookup = {},
				_trueFlagValue = {}
			;

			function _getModuleInfo (_moduleName,_callback) {
				var _moduleInfo = _moduleInfoLookup [_moduleName];
				_moduleInfo
					? _callback (_moduleInfo)
					: Uize.require (
						'UizeSite.ModuleInfo.' + _moduleName,
						function (_moduleInfo) {_callback (_moduleInfoLookup [_moduleName] = _moduleInfo ())}
					)
				;
			}

		/*** handle selection of test ***/
			function _generateDependencyBreakdownTable (_moduleName,_dependencies) {
				var
					_htmlChunks = [
						'<table border="1">',
							'<tr>',
								'<td>Segment</td>',
								'<td>Count</td>',
								'<td>Size (bytes)</td>',
								'<td>Size (%)</td>',
							'</tr>'
					],
					_totalSize = 0,
					_directDependenciesLookup = Uize.lookup (_moduleInfoLookup [_moduleName].directDependencies)
				;
				Uize.forEach (
					_dependencies,
					function (_moduleName) {_totalSize += _moduleInfoLookup [_moduleName].builtSize}
				);
				function _addDependenciesSegment (_segmentName,_segmentMatcher) {
					var
						_count = 0,
						_size = 0
					;
					Uize.forEach (
						_dependencies,
						function (_moduleName) {
							if (_segmentMatcher (_moduleName)) {
								_count++;
								_size += _moduleInfoLookup [_moduleName].builtSize;
							}
						}
					);
					_htmlChunks.push (
						'<tr>',
							'<td>' + _segmentName + '</td>',
							'<td style="text-align: right">' + _count + '</td>',
							'<td style="text-align: right">' + _size + '</td>',
							'<td style="text-align: right">' + (_size / _totalSize * 100).toFixed (2) + ' %</td>',
						'</tr>'
					);
				}
				_addDependenciesSegment ('Module',function (_dependency) {return _dependency == _moduleName});
				_addDependenciesSegment (
					'Direct Dependencies',
					function (_dependency) {return _dependency != _moduleName && _directDependenciesLookup [_dependency]}
				);
				_addDependenciesSegment (
					'Indirect Dependencies',
					function (_dependency) {return _dependency != _moduleName && !_directDependenciesLookup [_dependency]}
				);
				_addDependenciesSegment ('Total',Uize.returnTrue);
				_htmlChunks.push (
					'</table>'
				);
				return _htmlChunks.join ('');
			}

			function _handleSelection () {
				var _moduleName = _page.getNodeValue ('selector');
				if (_moduleName != _selectorPlaceholderText) {
					Uize.Util.Dependencies.Async.traceDependencies (
						_moduleName,
						function (_moduleName,_callback) {
							_getModuleInfo (
								_moduleName,
								function (_moduleInfo) {_callback (_moduleInfo.directDependencies)}
							);
						},
						[],
						function (_dependencies) {
							var
								_totalSize = 0,
								_htmlChunks = [],
								_minModuleSize = Infinity,
								_maxModuleSize = -Infinity,
								_totalSize = 0
							;
							Uize.forEach (
								_dependencies,
								function (_moduleName) {
									var _moduleSize = _moduleInfoLookup [_moduleName].builtSize;
									_totalSize += _moduleSize;
									_minModuleSize = Math.min (_minModuleSize,_moduleSize);
									_maxModuleSize = Math.max (_minModuleSize,_moduleSize);
								}
							);
							Uize.forEach (
								_dependencies,
								function (_moduleName) {
									var _moduleSize = _moduleInfoLookup [_moduleName].builtSize;
									_htmlChunks.unshift (
										'<div class="moduleInfoItem" style="height: ' + Math.max (20,_moduleSize / 100) + 'px;">' +
											_moduleName + ' (' + _moduleSize + ' bytes)' +
										'</div>'
									);
								}
							);
							page.setNodeInnerHtml ('moduleTotalSize',_generateDependencyBreakdownTable (_moduleName,_dependencies));
							page.setNodeInnerHtml ('moduleInfo',_htmlChunks.join (''));
						}
					);
				}
			}
			_page.wireNode ('selector','change',_handleSelection);

		/*** initialize ***/
			/*** populate selector ***/
				Uize.map (
					[_selectorPlaceholderText].concat (_modulesList),
					function (_moduleName) {return new Option (_moduleName,_moduleName)},
					_page.getNode ('selector').options
				);

			/*** initialize selector, using query param ***/
				_page.setNodeValue ('selector',Uize.Url.fromParams (location.href).module);
				_handleSelection ();
	}
});

</script>

</body>
</html>
